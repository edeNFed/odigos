apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: helm-chart
spec:
  description: This e2e test install Odigos via helm chart on custom namespace
  skipDelete: true
  steps:
  - name: Prepare destination
    try:
    - script:
        timeout: 300s
        content: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm install e2e-tests grafana/tempo-distributed -n traces --create-namespace \
          --set traces.otlp.grpc.enabled=true --set distributor.config.log_received_spans.enabled=true \
          --set ingester.config.replication_factor=1 --set ingester.config.trace_idle_period=100m \
          --set ingester.replicas=1 \
          --wait
#    - assert:
#        file: assert-tempo-running.yaml
  - name: Wait for destination to be ready
    try:
      - script:
          timeout: 60s
          content: ../../common/wait_for_dest.sh
  - name: Install Odigos
    try:
    - script:
        # TODO(edenfed): Use the latest version of the chart
        content: |
          git clone https://github.com/odigos-io/odigos-charts.git /tmp/odigos-charts -b align-with-cli
          # Retry 3 times to avoid flakiness
          while ! helm upgrade --install odigos /tmp/odigos-charts/charts/odigos --create-namespace --namespace odigos-test-ns --set image.tag=e2e-test; do
            echo "Failed to install Odigos, retrying..."
            sleep 1
          done
          kubectl label namespace odigos-test-ns odigos.io/system-object="true"
          rm -rf /tmp/odigos-charts
        timeout: 60s
  - name: Verify Odigos Installation
    try:
    - script:
        content: |
          export ACTUAL_VERSION=$(../../../cli/odigos version --cluster)
          if [ "$ACTUAL_VERSION" != "e2e-test" ]; then
            echo "Odigos version is not e2e-test, got $ACTUAL_VERSION"
            exit 1
          fi
    - assert:
        file: assert-odigos-installed.yaml
  - name: Install Demo App
    try:
    - script:
        timeout: 100s
        content: |
          docker pull keyval/odigos-demo-inventory:v0.1
          docker pull keyval/odigos-demo-membership:v0.1
          docker pull keyval/odigos-demo-coupon:v0.1
          docker pull keyval/odigos-demo-inventory:v0.1
          docker pull keyval/odigos-demo-frontend:v0.2
          kind load docker-image keyval/odigos-demo-inventory:v0.1
          kind load docker-image keyval/odigos-demo-membership:v0.1
          kind load docker-image keyval/odigos-demo-coupon:v0.1
          kind load docker-image keyval/odigos-demo-inventory:v0.1
          kind load docker-image keyval/odigos-demo-frontend:v0.2
    - apply:
        file: 02-install-simple-demo.yaml
    - assert:
        file: assert-apps-installed.yaml
  - name: Detect Languages
    try:
    - apply:
        file: 03-instrument-ns.yaml
    - assert:
        file: assert-runtime-detected.yaml
  - name: Add Destination
    try:
    - apply:
        file: 04-add-destination.yaml
    - assert:
        file: assert-instrumented-and-pipeline.yaml
  - name: Generate Traffic
    try:
      - create:
          file: 05-generate-traffic.yaml
      - assert:
          file: assert-traffic-job-running.yaml
          timeout: 20s
  - name: Wait for traces
    try:
    - script:
        timeout: 60s
        content: |
          while true; do
            ../../common/traceql_runner.sh tracesql/wait-for-trace.yaml
            if [ $? -eq 0 ]; then
              break
            fi
            sleep 3
          done
    catch:
    - podLogs:
        name: frontend
        namespace: default
  - name: Verify Trace - Context Propagation
    try:
    - script:
        content: |
          ../../common/traceql_runner.sh tracesql/context-propagation.yaml
    catch:
    - podLogs:
        name: odiglet
        namespace: odigos-system
  - name: Verify Trace - Resource Attributes
    try:
    - script:
        content: |
          ../../common/traceql_runner.sh tracesql/resource-attributes.yaml
    catch:
    - podLogs:
        name: odiglet
        namespace: odigos-system
  - name: Verify Trace - Span Attributes
    try:
      - script:
          content: |
            ../../common/traceql_runner.sh tracesql/span-attributes.yaml
    catch:
      - podLogs:
          name: odiglet
          namespace: odigos-system
